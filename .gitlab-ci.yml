stages:
  - Build Dev Image
  - Push Dev Image
  - Build Test Image
  - Push Test Image
  - Build Release Image
  - Push Release Image

variables:
  CONTAINER_DEV_IMAGE: $CI_REGISTRY/tygercaddy/tygercaddy:dev
  CONTAINER_TEST_IMAGE: $CI_REGISTRY/tygercaddy/tygercaddy:test
  CONTAINER_RELEASE_IMAGE: $CI_REGISTRY/tygercaddy/tygercaddy:latest

docker dev build:
  stage: Build Dev Image
  rules: 
    - if: '$CI_COMMIT_BRANCH == "dev"'
      when: always
  before_script:
    - docker info
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - export DOCKER_CLI_EXPERIMENTAL=enabled   
    - export CGO_ENABLED=0
    - docker run --rm --privileged docker/binfmt:820fdd95a9972a5308930a2bdfb8573dd4447ad3
    - cat /proc/sys/fs/binfmt_misc/qemu-aarch64
    - docker buildx use mybuilder
    - docker buildx inspect --bootstrap
  script:  
    - docker buildx build --platform linux/arm,linux/arm64,linux/amd64 -t $CONTAINER_DEV_IMAGE -t tygercaddy/tygercaddy:dev .

docker dev push:
  stage: Push Dev Image
  rules: 
    - if: '$CI_COMMIT_BRANCH == "dev"'
      when: always
  before_script:
    - docker info
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:  
    - docker push $CI_REGISTRY/tygercaddy/tygercaddy:dev

docker test build:
  stage: Build Test Image
  rules: 
    - if: $CI_COMMIT_BRANCH == "test"
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "test"
      when: always
  before_script:
    - docker info
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - export DOCKER_CLI_EXPERIMENTAL=enabled   
    - docker run --rm --privileged docker/binfmt:820fdd95a9972a5308930a2bdfb8573dd4447ad3
    - cat /proc/sys/fs/binfmt_misc/qemu-aarch64
    - docker buildx use mybuilder
    - docker buildx inspect --bootstrap

  script:  
    - docker buildx build --platform linux/arm,linux/arm64,linux/amd64 -t $CONTAINER_TEST_IMAGE -t tygercaddy/tygercaddy:test .

docker test push:
  stage: Push Test Image
  rules: 
    - if: $CI_COMMIT_BRANCH == "test"
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "test"
      when: always
  before_script:
    - docker info
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:  
    - docker push $CI_REGISTRY/tygercaddy/tygercaddy:test

docker release build:
  stage: Build Release Image
  rules: 
    - if: $CI_COMMIT_BRANCH == "master"
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "master"
      when: always
  before_script:
    - docker info
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - export DOCKER_CLI_EXPERIMENTAL=enabled   
    - docker run --rm --privileged docker/binfmt:820fdd95a9972a5308930a2bdfb8573dd4447ad3
    - cat /proc/sys/fs/binfmt_misc/qemu-aarch64
    - docker buildx use mybuilder
    - docker buildx inspect --bootstrap
  script:  
    - docker buildx build --platform linux/arm,linux/arm64,linux/amd64 -t $CONTAINER_RELEASE_IMAGE -t tygercaddy/tygercaddy:latest .
docker release push:
  stage: Push Release Image
  rules: 
    - if: $CI_COMMIT_BRANCH == "master"
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "master"
      when: always
  before_script:
    - docker info
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:  
    - docker push $CI_REGISTRY/tygercaddy/tygercaddy:latest